# report.r - 時系列分析レポート

## 概要

`report.r`は、博覧会の来場者数と気温データを用いた包括的な時系列分析を行うRスクリプトです。データの前処理から、定常性の確認、VARモデルの構築、因果関係の分析、予測まで、時系列分析の一連のワークフローを実装しています。

## 必要な環境

### Rパッケージ

以下のパッケージが必要です：

```r
install.packages(c(
  "lubridate",              # 日付データの処理
  "tseries",                # 時系列分析（ADF検定）
  "urca",                   # 単位根検定
  "vars",                   # ベクトル自己回帰（VAR）モデル
  "forecast",               # 時系列予測
  "PerformanceAnalytics",   # パフォーマンス分析
  "ggplot2"                 # 高度なグラフ作成
))
```

### データファイル

- **入力**: `/root/workspace/ToDM/dataset/expo_visitor_data.csv`
- **出力**: `/root/workspace/ToDM/fig/` ディレクトリに各種画像ファイル

## 実行方法

```r
source("/root/workspace/ToDM/report.r")
```

または、RStudioなどのIDE内でファイルを開き、全体を実行してください。

## 分析の流れ

### 1. データ読み込みと整形

**目的**: CSVファイルからデータを読み込み、分析可能な形式に整形

**処理内容**:
- `expo_visitor_data.csv`の読み込み
- 列名の統一（date, visitor_count, temperature）
- 日付型への変換
- 欠損値の除去
- 日付順のソート

**出力**:
- `fig/visitors.png`: 来場者数の日次推移
- `fig/temperature.png`: 気温の日次推移

### 2. 時系列の変換と定常性検定

**目的**: 非定常な時系列を定常化し、VARモデルの前提条件を満たす

**処理内容**:
- 来場者数の対数変換（`log1p()`）による分散安定化
- ADF検定（拡張ディッキー・フラー検定）による単位根検定
- 必要に応じた差分変換（最大2回まで）
- 定常性が確認されるまで自動的に差分を実行

**主な関数**:
- `make_stationary()`: 時系列を定常化する関数
  - ADF検定のp値が0.05以下になるまで差分を取る
  - 差分回数とp値をコンソールに出力

### 3. ACF/PACF分析

**目的**: 時系列の自己相関構造を把握し、適切なラグ次数を検討

**処理内容**:
- 定常化後の時系列に対するACF（自己相関関数）の計算
- PACF（偏自己相関関数）の計算

**出力**:
- `fig/acf_pacf_visitors_s.png`: 来場者数（定常化後）のACF/PACF
- `fig/acf_pacf_temp_s.png`: 気温（定常化後）のACF/PACF

### 4. VARモデルの次数選択と推定

**目的**: 最適なVARモデルを構築

**処理内容**:
- `VARselect()`による情報量規準に基づくラグ次数の選択
  - AIC、BIC、HQ、FPEの4つの規準を計算
  - 最大ラグ数: 14
- AIC規準に基づいて最適次数を自動選択
- VAR(p)モデルの推定

**出力**:
- コンソールに情報量規準の表と最適次数を表示
- VARモデルの推定結果（係数、標準誤差、t値、p値）

### 5. モデル診断

**目的**: 推定されたVARモデルの妥当性を検証

**実施する検定**:

#### a) 系列相関検定（Portmanteau検定）
- 残差に系列相関が残っていないかを確認
- ラグ12までの自己相関を検定

#### b) ARCH効果検定（多変量ARCH LM検定）
- 残差に条件付き分散不均一性（ボラティリティクラスタリング）がないかを確認
- ラグ12までの検定

#### c) 正規性検定（Jarque-Bera検定）
- 残差が正規分布に従うかを確認

**解釈**:
- p値 > 0.05 であれば問題なし（帰無仮説を棄却できない）

### 6. グレンジャー因果性検定

**目的**: 変数間の因果関係（予測的な影響関係）を検証

**検定内容**:
1. **気温 → 来場者**: 気温が来場者数の予測に有用か
2. **来場者 → 気温**: 来場者数が気温の予測に有用か

**結果の解釈**:
- p値 < 0.05: グレンジャー因果性あり（統計的に有意）
- p値 ≥ 0.05: グレンジャー因果性なし

### 7. インパルス応答関数（IRF）分析

**目的**: 一方の変数にショックが生じた際の動的な波及効果を分析

**分析内容**:
- **気温へのショック → 来場者数と気温への影響**
- **来場者数へのショック → 来場者数と気温への影響**
- 8期先まで追跡
- ブートストラップ法による信頼区間の計算

**出力**:
- `fig/irf_temp_to_visitors.png`: 気温ショックの波及効果
- `fig/irf_visitors_to_temp.png`: 来場者数ショックの波及効果

**解釈**:
- プロット上の信頼区間がゼロを跨がなければ、統計的に有意な影響あり

### 8. 予測誤差分散分解（FEVD）

**目的**: 各変数の予測誤差がどの程度他の変数によって説明されるかを定量化

**分析内容**:
- 8期先までの予測誤差分散を分解
- 各変数の寄与度を％で表示

**出力**:
- `fig/fevd.png`: 予測誤差分散分解の時系列推移

**解釈例**:
- 「来場者数の予測誤差の30%が気温によって説明される」など

### 9. 短期予測

**目的**: VARモデルを用いた将来の予測

**予測内容**:
- 7日先までの予測
- 95%信頼区間付き

**出力**:
- `fig/var_forecast_7days.png`: 来場者数（定常化後）の7日間予測
  - 予測値（青線）
  - 95%信頼区間（灰色の帯）

### 10. モデルサマリ

**出力内容**:
- 選択されたVAR次数
- 使用した観測値数
- 各変数の残差標準偏差

## 生成されるファイル一覧

| ファイル名 | 内容 |
|-----------|------|
| `fig/visitors.png` | 来場者数の原系列 |
| `fig/temperature.png` | 気温の原系列 |
| `fig/acf_pacf_visitors_s.png` | 来場者数（定常化後）のACF/PACF |
| `fig/acf_pacf_temp_s.png` | 気温（定常化後）のACF/PACF |
| `fig/irf_temp_to_visitors.png` | 気温→来場者・気温のIRF |
| `fig/irf_visitors_to_temp.png` | 来場者→来場者・気温のIRF |
| `fig/fevd.png` | 予測誤差分散分解 |
| `fig/var_forecast_7days.png` | 7日間予測（定常化後の来場者数） |

## コンソール出力内容

スクリプトを実行すると、以下の情報がコンソールに表示されます：

1. 定常化の過程（差分回数とADF検定のp値）
2. VAR次数選択の情報量規準（AIC, BIC, HQ, FPE）
3. 最適次数
4. VARモデルの推定結果（回帰係数と統計量）
5. モデル診断の各検定結果
6. グレンジャー因果性検定の結果
7. IRFの数値結果
8. FEVDの数値結果
9. 7日間予測の数値
10. モデルサマリ

## 主要な統計手法の解説

### ADF検定（Augmented Dickey-Fuller Test）
- **目的**: 時系列が単位根を持つか（非定常か）を検定
- **帰無仮説**: 単位根が存在する（非定常）
- **判定**: p値 < 0.05 なら定常と判断

### VAR（Vector AutoRegression）モデル
- **概要**: 複数の時系列変数を同時にモデル化
- **特徴**: 各変数が自身と他変数の過去値によって説明される
- **形式**: VAR(p)のpはラグ次数

### グレンジャー因果性
- **注意**: 真の因果関係ではなく「予測的有用性」を示す
- **意味**: 「XがYをグレンジャー因果する」= 「Xの過去値がYの予測に有用」

### IRF（Impulse Response Function）
- **意味**: ある変数に1単位のショックを与えたとき、他の変数がどう反応するか
- **用途**: 経済ショックの波及メカニズムの理解

### FEVD（Forecast Error Variance Decomposition）
- **意味**: 予測誤差のうち、各変数が何%説明するか
- **用途**: 変数間の相対的な影響力の測定

## よくある質問

### Q1: エラー「could not find function」が出る
**A**: 必要なパッケージがインストールされていません。冒頭の`install.packages()`を実行してください。

### Q2: 「オブジェクトが見つかりません」エラー
**A**: スクリプトを最初から順番に実行してください。途中から実行すると変数が定義されていない場合があります。

### Q3: 図が保存されない
**A**: `fig/`ディレクトリが自動作成されますが、親ディレクトリ（`/root/workspace/ToDM/`）が存在する必要があります。

### Q4: 定常化で差分が2回取られた
**A**: 元の時系列が強い非定常性を持っている可能性があります。通常は1回または2回の差分で定常化されます。

### Q5: VARの次数が大きすぎる（または小さすぎる）
**A**: `VARselect()`の`lag.max`パラメータを調整してください。データの特性に応じて適切な範囲を指定します。

## カスタマイズ方法

### 予測期間を変更
```r
h <- 14  # 7日から14日に変更
```

### VAR次数の選択基準を変更
```r
# AICからBICに変更
p_opt <- sel$selection["BIC(n)"]
```

### IRFの期間を変更
```r
irf_temp_to_vis <- irf(var_fit, impulse = "Temp_s", 
                       response = c("Visitors_s","Temp_s"), 
                       n.ahead = 20, boot = TRUE)  # 8→20に変更
```

### 図の解像度を変更
```r
png("/root/workspace/ToDM/fig/visitors.png", 1200, 900)  # 高解像度化
```

## 参考文献

- Hamilton, J. D. (1994). *Time Series Analysis*. Princeton University Press.
- Lütkepohl, H. (2005). *New Introduction to Multiple Time Series Analysis*. Springer.
- 沖本竜義 (2010). 『経済・ファイナンスデータの計量時系列分析』朝倉書店.

## 技術的な注意事項

1. **データパス**: 絶対パスが使用されています。環境に応じて変更が必要な場合があります。
2. **乱数シード**: IRFのブートストラップで乱数が使用されますが、シードは設定されていません。再現性が必要な場合は`set.seed()`を追加してください。
3. **メモリ使用**: ブートストラップ法（IRF）は計算量が多いため、大規模データでは時間がかかる場合があります。
4. **並列処理**: 現在は逐次処理です。高速化が必要な場合は`parallel`パッケージの利用を検討してください。

## ライセンス

このスクリプトは教育目的で作成されています。自由に使用・改変してください。
